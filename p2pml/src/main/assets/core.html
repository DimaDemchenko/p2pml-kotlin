<!DOCTYPE html>
<html lang="">
  <head>
    <title>WebView Example</title>
    <script type="importmap">
      {
        "imports": {
          "p2p-media-loader-core": "https://cdn.jsdelivr.net/npm/p2p-media-loader-core@^1/dist/p2p-media-loader-core.es.min.js"
        }
      }
    </script>

    <script type="module">
      import { Core } from "p2p-media-loader-core";

      class P2P {
        constructor() {
          this.core = new Core();
          this.port = null;
          this.listenPort();
        }

        listenPort() {
          window.addEventListener("message", (event) => {
            const port = event.ports[0];
            console.log("port received", port);
            console.log(window.postMessage);
            if (!port) return;
            this.port = port;
          });
        }

        parseAllStreams(jsonData) {
          const streams = JSON.parse(jsonData);
          for (const stream of streams) {
            this.core.addStreamIfNoneExists(stream);
          }
          console.log("streams", streams);
        }

        parseStream(jsonData) {
          const playlist = JSON.parse(jsonData);

          this.core.updateStream(
            playlist.streamRuntimeId,
            playlist.addSegments,
            playlist.removeSegmentsIds
          );
        }

        requestSegment(segmentUrl) {
          const onSuccess = (response) => {
            const copyData = new ArrayBuffer(response.data.byteLength);
            new Uint8Array(copyData).set(new Uint8Array(response.data));

            //this.port.postMessage(segmentUrl);
            //this.port.postMessage(copyData, [copyData]);
            this.port.postMessage({
              id: segmentUrl,
              buffer: copyData,
            });
          };

          const onError = (error) => {
            // TODO: Implement error handling
            console.error("error", error);
          };

          this.core.loadSegment(segmentUrl, {
            onSuccess,
            onError,
          });

          console.log("requestSegment", segmentUrl);
        }

        setManifestUrl(manifestUrl) {
          this.core.setManifestResponseUrl(manifestUrl);
          console.log("setManifestUrl", manifestUrl);
        }
      }

      const p2p = new P2P();
      window.p2p = p2p;
    </script>

    <script>
      function receiveMessageFromAndroid(message) {
        console.log("Message from Kotlin: " + message);
        console.log("port:", window.p2p);
        /*document.getElementById("message").innerHTML =
          "Message from Kotlin: " + message;*/
      }
    </script>
  </head>
  <body>
    <h1>WebView with JavaScript Bridge</h1>
    <p id="message">Waiting for a message from Kotlin...</p>
  </body>
</html>
