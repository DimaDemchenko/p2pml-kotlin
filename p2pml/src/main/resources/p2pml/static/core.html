<!DOCTYPE html>
<html lang="">
  <head>
    <title>WebView Example</title>
    <script type="importmap">
      {
        "imports": {
          "p2p-media-loader-core": "./js/p2p-media-loader-core.es.min.js"
        }
      }
    </script>

    <script type="module">
      import { Core } from "p2p-media-loader-core";

      class P2P {
        constructor() {
          this.core = new Core({
            highDemandTimeWindow: 30000,
          });
          this.port = null;
          this.listenPort();

          this.requestQueue = [];
          this.isProcessing = false;
        }

        listenPort() {
          window.addEventListener("message", (event) => {
            const port = event.ports[0];
            //console.log("port received", port);
            //console.log(window.postMessage);
            if (!port || this.port) {
              return;
            }
            this.port = port;
          });
        }

        parseAllStreams(jsonData) {
          const streams = JSON.parse(jsonData);
          for (const stream of streams) {
            this.core.addStreamIfNoneExists(stream);
          }
          console.log(">>> addStreamsIfNoneExist", streams);
        }

        parseStream(jsonData) {
          const playlist = JSON.parse(jsonData);
          const { streamRuntimeId, addSegments, removeSegmentsIds, isLive } =
            playlist;
          this.core.updateStream(
            streamRuntimeId,
            addSegments,
            removeSegmentsIds
          );
          this.core.setIsLive(isLive);
          //console.log(">>> updateStream", playlist);
          addSegments.forEach((segment) => {
            console.log(
              `>>> segment added: ${segment.externalId} | startTime: ${segment.startTime} - endTime: ${segment.endTime}`
            );
          });
        }

        processSegmentRequest(segmentRequestJSON) {
          const segmentRequest = JSON.parse(segmentRequestJSON);
          //console.log("segmentRequest", segmentRequest);
          const { segmentUrl, currentPlayPosition, currentPlaySpeed } =
            segmentRequest;
          console.log(">>> currentPosition:", currentPlayPosition);
          this.core.updatePlayback(currentPlayPosition, currentPlaySpeed);

          const onSuccess = (response) => {
            try {
              const copyData = new ArrayBuffer(response.data.byteLength);
              new Uint8Array(copyData).set(new Uint8Array(response.data));

              //console.log("Response data:", response);

              this.port.postMessage(segmentUrl);
              this.port.postMessage(copyData, [copyData]);
              //console.log(">>> response");
            } catch (e) {
              console.error("Error in onSuccess:", e);
            } finally {
              this.processNextRequest();
            }
          };

          const onError = (error) => {
            // TODO: Implement error handling
            //console.error("error", error);
            this.port.postMessage(`error|${segmentUrl}`);
            this.processNextRequest();
          };
          //console.log(">>> New request");
          this.core.loadSegment(segmentUrl, {
            onSuccess,
            onError,
          });

          //console.log("requestSegment", segmentUrl);
        }

        setManifestUrl(manifestUrl) {
          this.core.setManifestResponseUrl(manifestUrl);
          console.log("setManifestUrl", manifestUrl);
        }

        enqueueRequest(segmentRequestJSON) {
          console.log(">>> enqueueRequest", segmentRequestJSON);
          this.requestQueue.push(segmentRequestJSON);
          if (!this.isProcessing) {
            this.processNextRequest();
          }
        }

        processNextRequest() {
          if (this.requestQueue.length === 0) {
            this.isProcessing = false;
            return;
          }

          this.isProcessing = true;
          const segmentRequestJSON = this.requestQueue.shift();
          this.processSegmentRequest(segmentRequestJSON);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const p2p = new P2P();
        window.p2p = p2p;

        Android.onWebViewLoaded();
      });

      const p2p = new P2P();
      window.p2p = p2p;
    </script>
  </head>
  <body></body>
</html>
